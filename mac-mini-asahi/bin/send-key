#!/usr/bin/env bash
set -euo pipefail

usage() {
  cat >&2 <<'EOF'
usage:
  send_key_to_window.sh [--repeat N] [--delay SEC] [--focus] <address|-> <KEY or MOD+KEY>

examples:
  send_key_to_window.sh 0x13371337 Space
  send_key_to_window.sh 0x13371337 CTRL+T
  ./find_media_window.sh | send_key_to_window.sh - Space
  ./find_media_window.sh | send_key_to_window.sh --repeat 3 --delay 0.05 - Space
EOF
  exit 2
}

repeat=1
delay=0
focus=0

while [[ $# -gt 0 ]]; do
  case "$1" in
    --repeat) repeat="${2:?--repeat needs N}"; shift 2 ;;
    --delay)  delay="${2:?--delay needs seconds}"; shift 2 ;;
    --focus)  focus=1; shift ;;
    -h|--help) usage ;;
    *) break ;;
  esac
done

addr="${1:-}"
keyspec="${2:-}"
[[ -n "$addr" && -n "$keyspec" ]] || usage

if [[ "$addr" == "-" ]]; then
  addr="$(head -n1)"
fi

# trim whitespace/newlines
addr="${addr//$'\r'/}"
addr="$(echo -n "$addr" | tr -d '[:space:]')"

mods=""
key="$keyspec"

# Allow MOD+MOD+KEY syntax (e.g. CTRL+SHIFT+T)
if [[ "$keyspec" == *"+"* ]]; then
  IFS='+' read -r -a parts <<< "$keyspec"
  key="${parts[${#parts[@]}-1]}"
  if (( ${#parts[@]} > 1 )); then
    mods="${parts[0]}"
    for ((i=1; i<${#parts[@]}-1; i++)); do
      mods+=" ${parts[i]}"
    done
  fi
fi

# build hyprlang arg for sendshortcut: "mods, key, address:0x..."
if [[ -z "$mods" ]]; then
  arg=", ${key}, address:${addr}"
  arg2=", ${key}"
else
  arg="${mods}, ${key}, address:${addr}"
  arg2="${mods}, ${key}"
fi

send_direct() {
  hyprctl dispatch sendshortcut "$arg"
}

send_with_focus() {
  # needs jq (너 어차피 쓰고 있지)
  local prev
  prev="$(hyprctl -j activewindow | jq -r '.address // empty' 2>/dev/null || true)"

  hyprctl dispatch focuswindow "address:${addr}"
  hyprctl dispatch sendshortcut "$arg2"

  if [[ -n "$prev" && "$prev" != "$addr" ]]; then
    hyprctl dispatch focuswindow "address:${prev}"
  fi
}

for ((i=1; i<=repeat; i++)); do
  if (( focus )); then
    send_with_focus
  else
    send_direct
  fi

  if (( i < repeat )); then
    # sleep supports float seconds
    [[ "$delay" != "0" ]] && sleep "$delay"
  fi
done
